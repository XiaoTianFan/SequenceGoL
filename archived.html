<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cellular Automata MIDI Generator</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background-color: #f0f0f0;
        }
        
        .container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .main-layout {
            display: flex;
            gap: 30px;
            width: 100%;
            align-items: flex-start;
        }
        
        .left-panel {
            flex: 0 0 350px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .right-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 15px;
            align-items: center;
        }
        
        .controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .control-group {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #ddd;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .control-group h3 {
            margin: 0 0 10px 0;
            color: #333;
            font-size: 16px;
        }
        
        .instrument-controls {
            display: grid;
            grid-template-columns: repeat(11, 1fr);
            gap: 8px;
            margin-bottom: 15px;
        }
        
        .instrument-control {
            text-align: center;
            font-size: 12px;
        }
        
                .instrument-control select {
            width: 100px;
            padding: 3px;
            margin-top: 5px;
            border: 1px solid #ccc;
            border-radius: 3px;
            background: white;
        }
        
        .threshold-control {
            margin-top: 3px;
        }
        
        .threshold-control label {
            font-size: 10px;
            color: #666;
            display: block;
            margin-bottom: 2px;
        }
        
        .threshold-control select {
            width: 80px;
            padding: 2px;
            font-size: 11px;
        }
        
        .instrument-label {
            font-weight: bold;
            margin-bottom: 5px;
            padding: 4px;
            border-radius: 3px;
            color: white;
            font-size: 10px;
        }
        
        button {
            padding: 10px 20px;
            font-size: 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            background-color: #4CAF50;
            color: white;
        }
        
        button:hover {
            background-color: #45a049;
        }
        
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        
        .stop {
            background-color: #f44336;
        }
        
        .stop:hover {
            background-color: #da190b;
        }
        
        .clear {
            background-color: #ff9800;
        }
        
        .clear:hover {
            background-color: #e68900;
        }
        
        #grid {
            display: grid;
            grid-template-columns: repeat(88, 8px);
            grid-template-rows: repeat(88, 8px);
            gap: 1px;
            background-color: #ccc;
            padding: 2px;
            border: 2px solid #999;
            cursor: crosshair;
        }
        
        .cell {
            width: 8px;
            height: 8px;
            background-color: #fff;
        }
        
        .cell.alive {
            background-color: #000;
        }
        
        .cell.dying {
            background-color: #666;
        }
        
        .cell.music-bar {
            opacity: 0.3;
            z-index: 5;
            border: 1px solid rgba(255, 255, 255, 0.4);
        }
        
        /* Note 1 - A (Deep Red) */
        .cell.music-bar.note1 { background-color: rgba(139, 0, 0, 0.4); }
        .cell.music-bar.note1.alive { background-color: rgba(139, 0, 0, 0.7); }
        
        /* Note 2 - Bb (Saddle Brown) */
        .cell.music-bar.note2 { background-color: rgba(139, 69, 19, 0.4); }
        .cell.music-bar.note2.alive { background-color: rgba(139, 69, 19, 0.7); }
        
        /* Note 3 - C# (Dark Orange) */
        .cell.music-bar.note3 { background-color: rgba(255, 140, 0, 0.4); }
        .cell.music-bar.note3.alive { background-color: rgba(255, 140, 0, 0.7); }
        
        /* Note 4 - D (Lime Green) */
        .cell.music-bar.note4 { background-color: rgba(50, 205, 50, 0.4); }
        .cell.music-bar.note4.alive { background-color: rgba(50, 205, 50, 0.7); }
        
        /* Note 5 - E (Royal Blue) */
        .cell.music-bar.note5 { background-color: rgba(65, 105, 225, 0.4); }
        .cell.music-bar.note5.alive { background-color: rgba(65, 105, 225, 0.7); }
        
        /* Note 6 - F (Purple) */
        .cell.music-bar.note6 { background-color: rgba(128, 0, 128, 0.4); }
        .cell.music-bar.note6.alive { background-color: rgba(128, 0, 128, 0.7); }
        
        /* Note 7 - G (Crimson) */
        .cell.music-bar.note7 { background-color: rgba(220, 20, 60, 0.4); }
        .cell.music-bar.note7.alive { background-color: rgba(220, 20, 60, 0.7); }
        
        /* Note 8 - A↑ (Deep Pink) */
        .cell.music-bar.note8 { background-color: rgba(255, 20, 147, 0.4); }
        .cell.music-bar.note8.alive { background-color: rgba(255, 20, 147, 0.7); }
        
        /* Note 9 - C#↑ (Gold) */
        .cell.music-bar.note9 { background-color: rgba(255, 215, 0, 0.4); }
        .cell.music-bar.note9.alive { background-color: rgba(255, 215, 0, 0.7); }
        
        /* Note 10 - D↑ (Spring Green) */
        .cell.music-bar.note10 { background-color: rgba(0, 255, 127, 0.4); }
        .cell.music-bar.note10.alive { background-color: rgba(0, 255, 127, 0.7); }
        
        /* Note 11 - E↑ (Cyan) */
        .cell.music-bar.note11 { background-color: rgba(0, 255, 255, 0.4); }
        .cell.music-bar.note11.alive { background-color: rgba(0, 255, 255, 0.7); }
        
        .cell.music-bar.alive {
            opacity: 0.6;
            border: 2px solid rgba(0, 0, 0, 0.3);
        }
        
        .info {
            text-align: center;
            color: #666;
        }
        
        .generation {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }
        
        .speed-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        input[type="range"] {
            width: 150px;
        }
        
        #midiStatus {
            background: #e8f5e8;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
            border-left: 4px solid #4CAF50;
            text-align: center;
        }
        
        select {
            padding: 5px;
            border-radius: 3px;
            border: 1px solid #ccc;
            background: white;
        }
        
        .note1-label { background-color: #8B0000; }  /* A - Deep Red */
        .note2-label { background-color: #8B4513; }  /* Bb - Saddle Brown */
        .note3-label { background-color: #FF8C00; }  /* C# - Dark Orange */
        .note4-label { background-color: #32CD32; }  /* D - Lime Green */
        .note5-label { background-color: #4169E1; }  /* E - Royal Blue */
        .note6-label { background-color: #800080; }  /* F - Purple */
        .note7-label { background-color: #DC143C; }  /* G - Crimson */
        .note8-label { background-color: #FF1493; }  /* A↑ - Deep Pink */
        .note9-label { background-color: #FFD700; color: #000; }  /* C#↑ - Gold */
        .note10-label { background-color: #00FF7F; color: #000; } /* D↑ - Spring Green */
        .note11-label { background-color: #00FFFF; color: #000; } /* E↑ - Cyan */
    </style>
</head>
<body>
    <div class="container">
        <h1>Cellular Automata MIDI Generator</h1>
        <p style="text-align: center; color: #666; margin: -10px 0 20px 0;">Multiple cellular automata rules generating MIDI music</p>
        
        <div class="main-layout">
            <div class="left-panel">
                <div class="control-group">
                    <h3>Simulation Controls</h3>
                    <div class="controls">
                        <button id="startBtn">Start</button>
                        <button id="stopBtn" class="stop">Stop</button>
                        <button id="clearBtn" class="clear">Clear</button>
                    </div>
                    <div class="speed-control" style="margin-top: 10px;">
                        <span>Simulation BPM:</span>
                        <input type="number" id="simBpmInput" min="30" max="600" value="75" step="5" style="width: 80px; padding: 5px; margin: 0 10px; border: 1px solid #ccc; border-radius: 3px;">
                        <span id="simBpmValue">75 BPM</span>
                    </div>
                    <div class="speed-control" style="margin-top: 10px;">
                        <span>Rules:</span>
                        <select id="ruleSelect">
                            <option value="conway">Conway's Game of Life</option>
                            <option value="highlife">HighLife</option>
                            <option value="seeds">Seeds</option>
                            <option value="starwars">Star Wars</option>
                            <option value="briansbrain">Brian's Brain</option>
                            <option value="diamoeba">Diamoeba</option>
                        </select>
                    </div>
                    <div class="generation" style="margin-top: 10px;">Generation: <span id="generation">0</span></div>
                </div>
                
                <div class="control-group">
                    <h3>Music Controls</h3>
                    <div class="controls">
                        <button id="musicStartBtn">Start Music</button>
                        <button id="musicStopBtn" class="stop">Stop Music</button>
                    </div>
                    <div class="speed-control" style="margin-top: 10px;">
                        <span>Music BPM:</span>
                        <input type="range" id="bpmSlider" min="60" max="200" value="75" step="5" style="margin-right: 10px;">
                        <input type="number" id="bpmInput" min="30" max="300" value="75" step="1" style="width: 60px; padding: 3px; margin: 0 5px; border: 1px solid #ccc; border-radius: 3px;">
                        <span id="bpmValue">75 BPM</span>
                    </div>
                    <div class="speed-control" style="margin-top: 10px;">
                        <span>MIDI Output:</span>
                        <select id="midiOutputSelect">
                            <option>Loading...</option>
                        </select>
                        <button id="refreshMidiBtn" style="margin-left: 5px;">↻</button>
                    </div>
                </div>
            </div>
            
            <div class="right-panel">
                <div class="instrument-controls">
                    <div class="instrument-control">
                        <div class="instrument-label note1-label">A</div>
                        <select id="note1Beats">
                            <option value="4" selected>4 beats</option>
                            <option value="2">2 beats</option>
                            <option value="1">1 beat</option>
                            <option value="0.5">1/2 beat</option>
                            <option value="0.25">1/4 beat</option>
                            <option value="0.125">1/8 beat</option>
                            <option value="0.0625">1/16 beat</option>
                        </select>
                        <div class="threshold-control">
                            <label>Threshold:</label>
                            <select id="note1Threshold">
                                <option value="1">1 cell</option>
                                <option value="2">2 cells</option>
                                <option value="3">3 cells</option>
                                <option value="4">4 cells</option>
                                <option value="5">5 cells</option>
                                <option value="6">6 cells</option>
                                <option value="7">7 cells</option>
                                <option value="8" selected>8 cells</option>
                            </select>
                        </div>
                    </div>
                    <div class="instrument-control">
                        <div class="instrument-label note2-label">B♭</div>
                        <select id="note2Beats">
                            <option value="4">4 beats</option>
                            <option value="2" selected>2 beats</option>
                            <option value="1">1 beat</option>
                            <option value="0.5">1/2 beat</option>
                            <option value="0.25">1/4 beat</option>
                            <option value="0.125">1/8 beat</option>
                            <option value="0.0625">1/16 beat</option>
                        </select>
                        <div class="threshold-control">
                            <label>Threshold:</label>
                            <select id="note2Threshold">
                                <option value="1">1 cell</option>
                                <option value="2">2 cells</option>
                                <option value="3">3 cells</option>
                                <option value="4">4 cells</option>
                                <option value="5">5 cells</option>
                                <option value="6">6 cells</option>
                                <option value="7" selected>7 cells</option>
                                <option value="8">8 cells</option>
                            </select>
                        </div>
                    </div>
                    <div class="instrument-control">
                        <div class="instrument-label note3-label">C♯</div>
                        <select id="note3Beats">
                            <option value="4">4 beats</option>
                            <option value="2" selected>2 beats</option>
                            <option value="1">1 beat</option>
                            <option value="0.5">1/2 beat</option>
                            <option value="0.25">1/4 beat</option>
                            <option value="0.125">1/8 beat</option>
                            <option value="0.0625">1/16 beat</option>
                        </select>
                        <div class="threshold-control">
                            <label>Threshold:</label>
                            <select id="note3Threshold">
                                <option value="1">1 cell</option>
                                <option value="2">2 cells</option>
                                <option value="3">3 cells</option>
                                <option value="4">4 cells</option>
                                <option value="5">5 cells</option>
                                <option value="6" selected>6 cells</option>
                                <option value="7">7 cells</option>
                                <option value="8">8 cells</option>
                            </select>
                        </div>
                    </div>
                    <div class="instrument-control">
                        <div class="instrument-label note4-label">D</div>
                        <select id="note4Beats">
                            <option value="4">4 beats</option>
                            <option value="2">2 beats</option>
                            <option value="1" selected>1 beat</option>
                            <option value="0.5">1/2 beat</option>
                            <option value="0.25">1/4 beat</option>
                            <option value="0.125">1/8 beat</option>
                            <option value="0.0625">1/16 beat</option>
                        </select>
                        <div class="threshold-control">
                            <label>Threshold:</label>
                            <select id="note4Threshold">
                                <option value="1">1 cell</option>
                                <option value="2">2 cells</option>
                                <option value="3">3 cells</option>
                                <option value="4">4 cells</option>
                                <option value="5" selected>5 cells</option>
                                <option value="6">6 cells</option>
                                <option value="7">7 cells</option>
                                <option value="8">8 cells</option>
                            </select>
                        </div>
                    </div>
                    <div class="instrument-control">
                        <div class="instrument-label note5-label">E</div>
                        <select id="note5Beats">
                            <option value="4">4 beats</option>
                            <option value="2">2 beats</option>
                            <option value="1" selected>1 beat</option>
                            <option value="0.5">1/2 beat</option>
                            <option value="0.25">1/4 beat</option>
                            <option value="0.125">1/8 beat</option>
                            <option value="0.0625">1/16 beat</option>
                        </select>
                        <div class="threshold-control">
                            <label>Threshold:</label>
                            <select id="note5Threshold">
                                <option value="1">1 cell</option>
                                <option value="2">2 cells</option>
                                <option value="3">3 cells</option>
                                <option value="4" selected>4 cells</option>
                                <option value="5">5 cells</option>
                                <option value="6">6 cells</option>
                                <option value="7">7 cells</option>
                                <option value="8">8 cells</option>
                            </select>
                        </div>
                    </div>
                    <div class="instrument-control">
                        <div class="instrument-label note6-label">F</div>
                        <select id="note6Beats">
                            <option value="4">4 beats</option>
                            <option value="2">2 beats</option>
                            <option value="1" selected>1 beat</option>
                            <option value="0.5">1/2 beat</option>
                            <option value="0.25">1/4 beat</option>
                            <option value="0.125">1/8 beat</option>
                            <option value="0.0625">1/16 beat</option>
                        </select>
                        <div class="threshold-control">
                            <label>Threshold:</label>
                            <select id="note6Threshold">
                                <option value="1">1 cell</option>
                                <option value="2">2 cells</option>
                                <option value="3" selected>3 cells</option>
                                <option value="4">4 cells</option>
                                <option value="5">5 cells</option>
                                <option value="6">6 cells</option>
                                <option value="7">7 cells</option>
                                <option value="8">8 cells</option>
                            </select>
                        </div>
                    </div>
                    <div class="instrument-control">
                        <div class="instrument-label note7-label">G</div>
                        <select id="note7Beats">
                            <option value="4">4 beats</option>
                            <option value="2">2 beats</option>
                            <option value="1">1 beat</option>
                            <option value="0.5" selected>1/2 beat</option>
                            <option value="0.25">1/4 beat</option>
                            <option value="0.125">1/8 beat</option>
                            <option value="0.0625">1/16 beat</option>
                        </select>
                        <div class="threshold-control">
                            <label>Threshold:</label>
                            <select id="note7Threshold">
                                <option value="1">1 cell</option>
                                <option value="2">2 cells</option>
                                <option value="3" selected>3 cells</option>
                                <option value="4">4 cells</option>
                                <option value="5">5 cells</option>
                                <option value="6">6 cells</option>
                                <option value="7">7 cells</option>
                                <option value="8">8 cells</option>
                            </select>
                        </div>
                    </div>
                    <div class="instrument-control">
                        <div class="instrument-label note8-label">A↑</div>
                        <select id="note8Beats">
                            <option value="4">4 beats</option>
                            <option value="2">2 beats</option>
                            <option value="1">1 beat</option>
                            <option value="0.5" selected>1/2 beat</option>
                            <option value="0.25">1/4 beat</option>
                            <option value="0.125">1/8 beat</option>
                            <option value="0.0625">1/16 beat</option>
                        </select>
                        <div class="threshold-control">
                            <label>Threshold:</label>
                            <select id="note8Threshold">
                                <option value="1">1 cell</option>
                                <option value="2">2 cells</option>
                                <option value="3">3 cells</option>
                                <option value="4">4 cells</option>
                                <option value="5" selected>5 cells</option>
                                <option value="6">6 cells</option>
                                <option value="7">7 cells</option>
                                <option value="8">8 cells</option>
                            </select>
                        </div>
                    </div>
                    <div class="instrument-control">
                        <div class="instrument-label note9-label">C♯↑</div>
                        <select id="note9Beats">
                            <option value="4">4 beats</option>
                            <option value="2">2 beats</option>
                            <option value="1">1 beat</option>
                            <option value="0.5" selected>1/2 beat</option>
                            <option value="0.25">1/4 beat</option>
                            <option value="0.125">1/8 beat</option>
                            <option value="0.0625">1/16 beat</option>
                        </select>
                        <div class="threshold-control">
                            <label>Threshold:</label>
                            <select id="note9Threshold">
                                <option value="1">1 cell</option>
                                <option value="2">2 cells</option>
                                <option value="3">3 cells</option>
                                <option value="4" selected>4 cells</option>
                                <option value="5">5 cells</option>
                                <option value="6">6 cells</option>
                                <option value="7">7 cells</option>
                                <option value="8">8 cells</option>
                            </select>
                        </div>
                    </div>
                    <div class="instrument-control">
                        <div class="instrument-label note10-label">D↑</div>
                        <select id="note10Beats">
                            <option value="4">4 beats</option>
                            <option value="2">2 beats</option>
                            <option value="1">1 beat</option>
                            <option value="0.5">1/2 beat</option>
                            <option value="0.25" selected>1/4 beat</option>
                            <option value="0.125">1/8 beat</option>
                            <option value="0.0625">1/16 beat</option>
                        </select>
                        <div class="threshold-control">
                            <label>Threshold:</label>
                            <select id="note10Threshold">
                                <option value="1">1 cell</option>
                                <option value="2">2 cells</option>
                                <option value="3" selected>3 cells</option>
                                <option value="4">4 cells</option>
                                <option value="5">5 cells</option>
                                <option value="6">6 cells</option>
                                <option value="7">7 cells</option>
                                <option value="8">8 cells</option>
                            </select>
                        </div>
                    </div>
                    <div class="instrument-control">
                        <div class="instrument-label note11-label">E↑</div>
                        <select id="note11Beats">
                            <option value="4">4 beats</option>
                            <option value="2">2 beats</option>
                            <option value="1">1 beat</option>
                            <option value="0.5">1/2 beat</option>
                            <option value="0.25" selected>1/4 beat</option>
                            <option value="0.125">1/8 beat</option>
                            <option value="0.0625">1/16 beat</option>
                        </select>
                        <div class="threshold-control">
                            <label>Threshold:</label>
                            <select id="note11Threshold">
                                <option value="1">1 cell</option>
                                <option value="2" selected>2 cells</option>
                                <option value="3">3 cells</option>
                                <option value="4">4 cells</option>
                                <option value="5">5 cells</option>
                                <option value="6">6 cells</option>
                                <option value="7">7 cells</option>
                                <option value="8">8 cells</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div id="grid"></div>
            </div>
        </div>
        
        <div class="info">
            <p><strong>Instructions:</strong></p>
            <p>Left click and drag to create living cells • Right click and drag to kill cells</p>
            <p><strong>Rules:</strong> Conway's (B3/S23), HighLife (B36/S23), Seeds (B2/S), Star Wars (B2/S345), Brian's Brain (3-state), Diamoeba (B35678/S5678)</p>
            <p><strong>Music:</strong> 11 columns of 8x8 boxes scan the 88x88 grid using A Phrygian Dominant scale. Set Music BPM and beat timing for each note.</p>
            <p><strong>MIDI:</strong> Sends notes to your selected output device. Connect to a DAW or hardware synthesizer.</p>
            <p><strong>Scale:</strong> A, B♭, C♯, D, E, F, G, A↑, C♯↑, D↑, E↑ (Channels 1-11)</p>
            <p><strong>Controls:</strong> Simulation BPM controls cellular automata speed, Music BPM controls note timing independently.</p>
        </div>
    </div>

    <script>
        class CellularAutomata {
            constructor() {
                this.gridSize = 88;
                this.grid = [];
                this.nextGrid = [];
                this.isRunning = false;
                this.generation = 0;
                this.simBpm = 75; // Simulation BPM
                this.intervalId = null;
                this.isMouseDown = false;
                this.isRightClick = false;
                this.currentRule = 'conway'; // Default rule set
                this.maxStates = 2; // Maximum cell states (2 for binary, 3 for Brian's Brain)
                
                // Music bar properties - 11 independent boxes
                this.musicBarHeight = 8;
                this.musicBarWidth = 8;
                this.isMusicRunning = false;
                this.bpm = 75; // Beats per minute
                this.sectionsCount = 11; // 11 columns of 8x8 boxes
                
                // 11 musical boxes with A Phrygian Dominant scale
                this.musicBoxes = [
                    { name: 'note1', column: 0, position: 0, beats: 4, threshold: 8, intervalId: null, color: 'note1' },     // A
                    { name: 'note2', column: 1, position: 8, beats: 2, threshold: 7, intervalId: null, color: 'note2' },     // Bb
                    { name: 'note3', column: 2, position: 16, beats: 2, threshold: 6, intervalId: null, color: 'note3' },    // C#
                    { name: 'note4', column: 3, position: 24, beats: 1, threshold: 5, intervalId: null, color: 'note4' },    // D
                    { name: 'note5', column: 4, position: 32, beats: 1, threshold: 4, intervalId: null, color: 'note5' },    // E
                    { name: 'note6', column: 5, position: 40, beats: 1, threshold: 3, intervalId: null, color: 'note6' },    // F
                    { name: 'note7', column: 6, position: 48, beats: 0.5, threshold: 3, intervalId: null, color: 'note7' },  // G
                    { name: 'note8', column: 7, position: 56, beats: 0.5, threshold: 5, intervalId: null, color: 'note8' },  // A (octave higher)
                    { name: 'note9', column: 8, position: 64, beats: 0.5, threshold: 4, intervalId: null, color: 'note9' },  // C# (octave higher)
                    { name: 'note10', column: 9, position: 72, beats: 0.25, threshold: 3, intervalId: null, color: 'note10' }, // D (octave higher)
                    { name: 'note11', column: 10, position: 80, beats: 0.25, threshold: 2, intervalId: null, color: 'note11' } // E (octave higher)
                ];
                
                // MIDI properties
                this.midiAccess = null;
                this.midiOutput = null;
                this.initializeMIDI();
                
                // MIDI note numbers for A Phrygian Dominant scale
                this.instrumentNotes = {
                    note1: 45,     // A2 - Root note
                    note2: 46,     // Bb2 - Minor second
                    note3: 49,     // C#3 - Major third
                    note4: 50,     // D3 - Perfect fourth
                    note5: 52,     // E3 - Perfect fifth
                    note6: 53,     // F3 - Minor sixth
                    note7: 55,     // G3 - Minor seventh
                    note8: 57,     // A3 - Root note (octave higher)
                    note9: 61,     // C#4 - Major third (octave higher)
                    note10: 62,    // D4 - Perfect fourth (octave higher)
                    note11: 64     // E4 - Perfect fifth (octave higher)
                };
                
                // MIDI channels for each note (1-16)
                this.instrumentChannels = {
                    note1: 1,
                    note2: 2,
                    note3: 3,
                    note4: 4,
                    note5: 5,
                    note6: 6,
                    note7: 7,
                    note8: 8,
                    note9: 9,
                    note10: 10,
                    note11: 11
                };
                
                // Track active notes to avoid overlapping
                this.activeNotes = new Map();
                
                this.initializeGrid();
                this.createGridElements();
                this.attachEventListeners();
            }
            
            initializeGrid() {
                // Initialize with 0 (dead) for all rules
                this.grid = Array(this.gridSize).fill().map(() => Array(this.gridSize).fill(0));
                this.nextGrid = Array(this.gridSize).fill().map(() => Array(this.gridSize).fill(0));
            }
            
            createGridElements() {
                const gridContainer = document.getElementById('grid');
                gridContainer.innerHTML = '';
                
                for (let row = 0; row < this.gridSize; row++) {
                    for (let col = 0; col < this.gridSize; col++) {
                        const cell = document.createElement('div');
                        cell.className = 'cell';
                        cell.dataset.row = row;
                        cell.dataset.col = col;
                        gridContainer.appendChild(cell);
                    }
                }
            }
            
            attachEventListeners() {
                const startBtn = document.getElementById('startBtn');
                const stopBtn = document.getElementById('stopBtn');
                const clearBtn = document.getElementById('clearBtn');
                const simBpmInput = document.getElementById('simBpmInput');
                const simBpmValue = document.getElementById('simBpmValue');
                const gridContainer = document.getElementById('grid');
                const ruleSelect = document.getElementById('ruleSelect');
                
                startBtn.addEventListener('click', () => this.start());
                stopBtn.addEventListener('click', () => this.stop());
                clearBtn.addEventListener('click', () => this.clear());
                
                ruleSelect.addEventListener('change', (e) => {
                    this.currentRule = e.target.value;
                    console.log(`Rule changed to: ${this.currentRule}`);
                });
                
                simBpmInput.addEventListener('input', (e) => {
                    this.simBpm = parseInt(e.target.value);
                    simBpmValue.textContent = this.simBpm + ' BPM';
                    if (this.isRunning) {
                        this.stop();
                        this.start();
                    }
                });
                
                // Music bar controls
                const musicStartBtn = document.getElementById('musicStartBtn');
                const musicStopBtn = document.getElementById('musicStopBtn');
                const bpmSlider = document.getElementById('bpmSlider');
                const bpmValue = document.getElementById('bpmValue');
                
                musicStartBtn.addEventListener('click', () => this.startMusic());
                musicStopBtn.addEventListener('click', () => this.stopMusic());
                
                const bpmInput = document.getElementById('bpmInput');
                
                const updateBpm = (value) => {
                    this.bpm = parseInt(value);
                    bpmSlider.value = this.bpm;
                    bpmInput.value = this.bpm;
                    bpmValue.textContent = this.bpm + ' BPM';
                    
                    if (this.isMusicRunning) {
                        this.stopMusic();
                        this.startMusic();
                    }
                };
                
                bpmSlider.addEventListener('input', (e) => {
                    updateBpm(e.target.value);
                });
                
                bpmInput.addEventListener('input', (e) => {
                    const value = Math.max(30, Math.min(300, parseInt(e.target.value) || 120));
                    updateBpm(value);
                });
                
                // Beat selection controls
                const notes = ['note1', 'note2', 'note3', 'note4', 'note5', 'note6', 'note7', 'note8', 'note9', 'note10', 'note11'];
                notes.forEach((note, index) => {
                    const select = document.getElementById(note + 'Beats');
                    select.addEventListener('change', (e) => {
                        this.musicBoxes[index].beats = parseFloat(e.target.value);
                        if (this.isMusicRunning) {
                            this.stopMusic();
                            this.startMusic();
                        }
                    });
                });
                
                // Threshold selection controls
                notes.forEach((note, index) => {
                    const thresholdSelect = document.getElementById(note + 'Threshold');
                    if (thresholdSelect) {
                        thresholdSelect.addEventListener('change', (e) => {
                            this.musicBoxes[index].threshold = parseInt(e.target.value);
                        });
                    }
                });
                
                // MIDI device selection
                const midiOutputSelect = document.getElementById('midiOutputSelect');
                const refreshMidiBtn = document.getElementById('refreshMidiBtn');
                
                midiOutputSelect.addEventListener('change', (e) => {
                    this.selectMIDIDevice(e.target.value);
                });
                
                refreshMidiBtn.addEventListener('click', () => {
                    this.updateMIDIDeviceList();
                });
                
                // Mouse events for drawing
                gridContainer.addEventListener('mousedown', (e) => {
                    e.preventDefault();
                    this.isMouseDown = true;
                    this.isRightClick = e.button === 2;
                    this.handleCellClick(e);
                });
                
                gridContainer.addEventListener('mousemove', (e) => {
                    if (this.isMouseDown) {
                        this.handleCellClick(e);
                    }
                });
                
                gridContainer.addEventListener('mouseup', () => {
                    this.isMouseDown = false;
                });
                
                gridContainer.addEventListener('mouseleave', () => {
                    this.isMouseDown = false;
                });
                
                // Prevent context menu on right click
                gridContainer.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                });
                
                // Prevent text selection while dragging
                gridContainer.addEventListener('selectstart', (e) => {
                    e.preventDefault();
                });
            }
            
            handleCellClick(e) {
                if (e.target.classList.contains('cell')) {
                    const centerRow = parseInt(e.target.dataset.row);
                    const centerCol = parseInt(e.target.dataset.col);
                    
                    // Affect a 3x3 area around the click
                    for (let i = -1; i <= 1; i++) {
                        for (let j = -1; j <= 1; j++) {
                            const row = centerRow + i;
                            const col = centerCol + j;
                            
                            // Check if the position is within grid bounds
                            if (row >= 0 && row < this.gridSize && col >= 0 && col < this.gridSize) {
                                const isCenterCell = (i === 0 && j === 0);
                                const shouldAffect = isCenterCell || Math.random() < 0.6; // 60% chance for outer cells
                                
                                if (shouldAffect) {
                                    const cellIndex = row * this.gridSize + col;
                                    const cellElement = document.querySelectorAll('.cell')[cellIndex];
                                    
                                    if (this.isRightClick) {
                                        // Right click kills cells
                                        this.grid[row][col] = 0;
                                        cellElement.classList.remove('alive', 'dying');
                                    } else {
                                        // Left click creates cells
                                        this.grid[row][col] = 1;
                                        cellElement.classList.add('alive');
                                        cellElement.classList.remove('dying');
                                    }
                                }
                            }
                        }
                    }
                }
            }
            
            countNeighbors(row, col, state = 1) {
                let count = 0;
                for (let i = -1; i <= 1; i++) {
                    for (let j = -1; j <= 1; j++) {
                        if (i === 0 && j === 0) continue;
                        
                        const newRow = row + i;
                        const newCol = col + j;
                        
                        if (newRow >= 0 && newRow < this.gridSize && 
                            newCol >= 0 && newCol < this.gridSize && 
                            this.grid[newRow][newCol] === state) {
                            count++;
                        }
                    }
                }
                return count;
            }
            
            calculateTiming(beats) {
                // Convert beats to milliseconds based on BPM
                // 60000ms per minute / BPM = ms per beat
                const msPerBeat = 60000 / this.bpm;
                return msPerBeat * beats;
            }
            
            calculateSimulationTiming() {
                // Convert simulation BPM to milliseconds per step
                // 60000ms per minute / BPM = ms per beat (step)
                return 60000 / this.simBpm;
            }
            
            updateGrid() {
                // Calculate next generation based on current rule set
                for (let row = 0; row < this.gridSize; row++) {
                    for (let col = 0; col < this.gridSize; col++) {
                        const currentState = this.grid[row][col];
                        const aliveNeighbors = this.countNeighbors(row, col, 1);
                        
                        this.nextGrid[row][col] = this.applyRule(currentState, aliveNeighbors, row, col);
                    }
                }
                
                // Swap grids
                [this.grid, this.nextGrid] = [this.nextGrid, this.grid];
                
                // Update display
                this.renderGrid();
                
                // Update generation counter
                this.generation++;
                document.getElementById('generation').textContent = this.generation;
            }
            
            applyRule(currentState, aliveNeighbors, row, col) {
                switch (this.currentRule) {
                    case 'conway':
                        // Conway's Game of Life: B3/S23
                        if (currentState === 1) {
                            return (aliveNeighbors === 2 || aliveNeighbors === 3) ? 1 : 0;
                        } else {
                            return aliveNeighbors === 3 ? 1 : 0;
                        }
                        
                    case 'highlife':
                        // HighLife: B36/S23
                        if (currentState === 1) {
                            return (aliveNeighbors === 2 || aliveNeighbors === 3) ? 1 : 0;
                        } else {
                            return (aliveNeighbors === 3 || aliveNeighbors === 6) ? 1 : 0;
                        }
                        
                    case 'seeds':
                        // Seeds: B2/S
                        if (currentState === 1) {
                            return 0; // All living cells die
                        } else {
                            return aliveNeighbors === 2 ? 1 : 0;
                        }
                        
                    case 'starwars':
                        // Star Wars: B2/S345
                        if (currentState === 1) {
                            return (aliveNeighbors === 3 || aliveNeighbors === 4 || aliveNeighbors === 5) ? 1 : 0;
                        } else {
                            return aliveNeighbors === 2 ? 1 : 0;
                        }
                        
                    case 'briansbrain':
                        // Brian's Brain: 3-state automaton
                        // 0 = dead, 1 = alive, 2 = dying
                        if (currentState === 0) {
                            // Dead cell becomes alive if exactly 2 living neighbors
                            return aliveNeighbors === 2 ? 1 : 0;
                        } else if (currentState === 1) {
                            // Living cell becomes dying
                            return 2;
                        } else {
                            // Dying cell becomes dead
                            return 0;
                        }
                        
                    case 'diamoeba':
                        // Diamoeba: B35678/S5678
                        if (currentState === 1) {
                            return (aliveNeighbors >= 5 && aliveNeighbors <= 8) ? 1 : 0;
                        } else {
                            return (aliveNeighbors === 3 || (aliveNeighbors >= 5 && aliveNeighbors <= 8)) ? 1 : 0;
                        }
                        
                    default:
                        // Default to Conway's Game of Life
                        if (currentState === 1) {
                            return (aliveNeighbors === 2 || aliveNeighbors === 3) ? 1 : 0;
                        } else {
                            return aliveNeighbors === 3 ? 1 : 0;
                        }
                }
            }
            
            renderGrid() {
                const cells = document.querySelectorAll('.cell');
                cells.forEach((cell, index) => {
                    const row = Math.floor(index / this.gridSize);
                    const col = index % this.gridSize;
                    const state = this.grid[row][col];
                    
                    // Remove all state classes
                    cell.classList.remove('alive', 'dying');
                    
                    // Add appropriate class based on state
                    if (state === 1) {
                        cell.classList.add('alive');
                    } else if (state === 2) {
                        cell.classList.add('dying');
                    }
                    // state === 0 remains as default (dead/white)
                });
            }
            
            start() {
                if (!this.isRunning) {
                    this.isRunning = true;
                    const timing = this.calculateSimulationTiming();
                    this.intervalId = setInterval(() => this.updateGrid(), timing);
                    document.getElementById('startBtn').disabled = true;
                    document.getElementById('stopBtn').disabled = false;
                }
            }
            
            stop() {
                if (this.isRunning) {
                    this.isRunning = false;
                    clearInterval(this.intervalId);
                    document.getElementById('startBtn').disabled = false;
                    document.getElementById('stopBtn').disabled = true;
                }
            }
            
            clear() {
                this.stop();
                this.initializeGrid();
                this.renderGrid();
                this.generation = 0;
                document.getElementById('generation').textContent = this.generation;
            }
            
            updateMusicBox(boxIndex) {
                const box = this.musicBoxes[boxIndex];
                const cells = document.querySelectorAll('.cell');
                
                // Clear previous box position for this instrument
                cells.forEach(cell => {
                    if (cell.classList.contains(box.color)) {
                        cell.classList.remove('music-bar', box.color);
                    }
                });
                
                // Calculate the 8x8 box position
                const startCol = box.column * this.musicBarWidth;
                const endCol = startCol + this.musicBarWidth;
                const startRow = box.position;
                const endRow = box.position + this.musicBarHeight;
                
                // Count alive cells in this 8x8 box
                let aliveCount = 0;
                
                // Draw the box and count alive cells
                for (let row = startRow; row < endRow && row < this.gridSize; row++) {
                    for (let col = startCol; col < endCol && col < this.gridSize; col++) {
                        const cellIndex = row * this.gridSize + col;
                        if (cellIndex < cells.length) {
                            cells[cellIndex].classList.add('music-bar', box.color);
                            
                            // Count alive cells (state 1)
                            if (this.grid[row][col] === 1) {
                                aliveCount++;
                            }
                        }
                    }
                }
                
                // Play tone based on alive cells
                this.playBoxTone(box, aliveCount);
                
                // Move box to next position (wrap around)
                box.position += this.musicBarHeight;
                if (box.position >= this.gridSize) {
                    box.position = 0;
                }
            }
            
            playBoxTone(box, aliveCount) {
                if (aliveCount === 0 || !this.midiOutput) return;
                
                const baseNote = this.instrumentNotes[box.name];
                const channel = this.instrumentChannels[box.name] - 1; // MIDI channels are 0-indexed in Web MIDI API
                
                // Create musical variations based on cell count (Phrygian Dominant intervals)
                const noteVariations = [
                    0,   // Root note
                    1,   // Minor second (Phrygian characteristic)
                    4,   // Major third
                    7,   // Perfect fifth  
                    12   // Octave
                ];
                
                const noteOffset = noteVariations[Math.min(aliveCount - 1, 4)];
                const midiNote = Math.max(0, Math.min(127, baseNote + noteOffset));
                
                // Different characteristics based on note position in scale
                let shouldPlay = false;
                let velocity = 64; // Default velocity
                let duration = 500; // Default duration in ms
                
                // Get note index (0-10) and use custom threshold
                const noteIndex = parseInt(box.name.replace('note', '')) - 1;
                
                // Use the box's custom threshold instead of hardcoded values
                shouldPlay = aliveCount >= box.threshold;
                
                if (noteIndex < 7) {
                    // Lower octave notes (A, Bb, C#, D, E, F, G)
                    velocity = Math.min(127, 60 + aliveCount * 4 + noteIndex * 2);
                    duration = Math.max(200, 800 - noteIndex * 80);
                } else {
                    // Higher octave notes (A↑, C#↑, D↑, E↑)
                    velocity = Math.min(127, 70 + aliveCount * 5);
                    duration = Math.max(100, 300 - (noteIndex - 7) * 40);
                }
                
                if (shouldPlay) {
                    this.playMIDINote(midiNote, velocity, duration, channel, box.name);
                }
            }
            
            countAliveCellsInLayerSection(layerPosition, section) {
                const startCol = section * this.musicBarWidth;
                const endCol = Math.min(startCol + this.musicBarWidth, this.gridSize);
                let aliveCount = 0;
                
                for (let row = layerPosition; row < layerPosition + this.musicBarHeight && row < this.gridSize; row++) {
                    for (let col = startCol; col < endCol; col++) {
                        if (row >= 0 && row < this.gridSize && col >= 0 && col < this.gridSize) {
                            if (this.grid[row][col] === 1) {
                                aliveCount++;
                            }
                        }
                    }
                }
                
                return aliveCount;
            }
            
            startMusic() {
                if (!this.isMusicRunning) {
                    this.isMusicRunning = true;
                    
                    // Start each box with its own timing based on BPM and beats
                    // Stagger the start times by 1/8 beat (0.125 beats) for each box
                    this.musicBoxes.forEach((box, index) => {
                        const timing = this.calculateTiming(box.beats);
                        const startDelay = this.calculateTiming(0.125) * index; // 1/8 beat * box index
                        
                        setTimeout(() => {
                            if (this.isMusicRunning) { // Check if still running when timeout executes
                                box.intervalId = setInterval(() => this.updateMusicBox(index), timing);
                            }
                        }, startDelay);
                    });
                    
                    document.getElementById('musicStartBtn').disabled = true;
                    document.getElementById('musicStopBtn').disabled = false;
                }
            }
            
            stopMusic() {
                if (this.isMusicRunning) {
                    this.isMusicRunning = false;
                    
                    // Stop all boxes
                    this.musicBoxes.forEach(box => {
                        if (box.intervalId) {
                            clearInterval(box.intervalId);
                            box.intervalId = null;
                        }
                    });
                    
                    // Stop all active MIDI notes
                    this.stopAllMIDINotes();
                    
                // Clear all music bars from display
                const cells = document.querySelectorAll('.cell');
                cells.forEach(cell => {
                    cell.classList.remove('music-bar', 'note1', 'note2', 'note3', 'note4', 'note5', 'note6', 'note7', 'note8', 'note9', 'note10', 'note11');
                });                    document.getElementById('musicStartBtn').disabled = false;
                    document.getElementById('musicStopBtn').disabled = true;
                }
            }
            
            stopAllMIDINotes() {
                // Stop all active notes and clear timeouts
                this.activeNotes.forEach((timeoutId, noteKey) => {
                    clearTimeout(timeoutId);
                    const [channel, note] = noteKey.split('-').map(Number);
                    this.sendNoteOff(note, channel);
                });
                this.activeNotes.clear();
                
                // Send All Notes Off for all channels (MIDI CC 123)
                for (let channel = 0; channel < 16; channel++) {
                    if (this.midiOutput) {
                        this.midiOutput.send([0xB0 | channel, 123, 0]);
                    }
                }
            }
            
            async initializeMIDI() {
                try {
                    this.midiAccess = await navigator.requestMIDIAccess();
                    
                    // Listen for device changes
                    this.midiAccess.addEventListener('statechange', () => {
                        this.updateMIDIDeviceList();
                    });
                    
                    // Initial device list update
                    this.updateMIDIDeviceList();
                    
                } catch (e) {
                    console.warn('Web MIDI API not supported:', e);
                    // Fallback to console logging
                    this.midiOutput = {
                        name: 'Console MIDI Logger',
                        id: 'console',
                        send: (message) => {
                            const [status, note, velocity] = message;
                            const isNoteOn = (status & 0xF0) === 0x90;
                            const channel = (status & 0x0F) + 1;
                            const action = isNoteOn ? 'Note ON' : 'Note OFF';
                            console.log(`${action}: Channel ${channel}, Note ${note}, Velocity ${velocity}`);
                        }
                    };
                    this.updateMIDIDeviceList();
                }
            }
            
            updateMIDIDeviceList() {
                const select = document.getElementById('midiOutputSelect');
                select.innerHTML = '';
                
                if (this.midiAccess) {
                    const outputs = Array.from(this.midiAccess.outputs.values());
                    
                    if (outputs.length > 0) {
                        outputs.forEach(output => {
                            const option = document.createElement('option');
                            option.value = output.id;
                            option.textContent = output.name;
                            select.appendChild(option);
                        });
                        
                        // Set first device as default if no device is selected
                        if (!this.midiOutput || !outputs.find(o => o.id === this.midiOutput.id)) {
                            this.midiOutput = outputs[0];
                            select.value = outputs[0].id;
                        }
                    } else {
                        const option = document.createElement('option');
                        option.value = 'virtual';
                        option.textContent = 'Virtual MIDI Output (Console)';
                        select.appendChild(option);
                        
                        this.midiOutput = {
                            name: 'Virtual MIDI Output',
                            id: 'virtual',
                            send: (message) => {
                                const [status, note, velocity] = message;
                                const isNoteOn = (status & 0xF0) === 0x90;
                                const channel = (status & 0x0F) + 1;
                                const action = isNoteOn ? 'Note ON' : 'Note OFF';
                                console.log(`${action}: Channel ${channel}, Note ${note}, Velocity ${velocity}`);
                            }
                        };
                    }
                } else {
                    const option = document.createElement('option');
                    option.value = 'console';
                    option.textContent = 'Console MIDI Logger';
                    select.appendChild(option);
                }
                
                this.updateMIDIStatus();
            }
            
            selectMIDIDevice(deviceId) {
                if (this.midiAccess) {
                    const outputs = Array.from(this.midiAccess.outputs.values());
                    const selectedOutput = outputs.find(output => output.id === deviceId);
                    if (selectedOutput) {
                        this.midiOutput = selectedOutput;
                        this.updateMIDIStatus();
                        console.log(`Selected MIDI output: ${selectedOutput.name}`);
                    }
                }
            }
            
            updateMIDIStatus() {
                // Add MIDI status to the page
                const container = document.querySelector('.container');
                let statusDiv = document.getElementById('midiStatus');
                
                if (!statusDiv) {
                    statusDiv = document.createElement('div');
                    statusDiv.id = 'midiStatus';
                    statusDiv.style.cssText = 'background: #e8f5e8; padding: 10px; border-radius: 5px; margin: 10px 0; border-left: 4px solid #4CAF50;';
                    container.insertBefore(statusDiv, container.children[2]); // Insert after controls
                }
                
                statusDiv.innerHTML = `
                    <strong>MIDI Status:</strong> Connected to "${this.midiOutput.name}"<br>
                    <small>MIDI notes will be sent to this output when music is playing.</small>
                `;
            }
            
            playMIDINote(note, velocity, duration, channel, instrumentName) {
                if (!this.midiOutput) return;
                
                // Create unique key for tracking active notes
                const noteKey = `${channel}-${note}`;
                
                // Stop any existing note on this channel/note combination
                if (this.activeNotes.has(noteKey)) {
                    clearTimeout(this.activeNotes.get(noteKey));
                    this.sendNoteOff(note, channel);
                }
                
                // Send note on
                this.sendNoteOn(note, velocity, channel);
                
                // Schedule note off
                const timeoutId = setTimeout(() => {
                    this.sendNoteOff(note, channel);
                    this.activeNotes.delete(noteKey);
                }, duration);
                
                this.activeNotes.set(noteKey, timeoutId);
            }
            
            sendNoteOn(note, velocity, channel) {
                const message = [0x90 | channel, note, velocity]; // Note On message
                this.midiOutput.send(message);
            }
            
            sendNoteOff(note, channel) {
                const message = [0x80 | channel, note, 0]; // Note Off message
                this.midiOutput.send(message);
            }
            
            countAliveCellsInSection(section) {
                const startCol = section * this.musicBarWidth;
                const endCol = Math.min(startCol + this.musicBarWidth, this.gridSize);
                let aliveCount = 0;
                
                // Note: this.musicBarPosition should be defined if this function is used
                const currentPosition = this.musicBarPosition || 0;
                for (let row = currentPosition; row < currentPosition + this.musicBarHeight && row < this.gridSize; row++) {
                    for (let col = startCol; col < endCol; col++) {
                        if (row >= 0 && row < this.gridSize && col >= 0 && col < this.gridSize) {
                            if (this.grid[row][col] === 1) {
                                aliveCount++;
                            }
                        }
                    }
                }
                
                return aliveCount;
            }
        }
        
        // Initialize the cellular automata when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            new CellularAutomata();
        });
    </script>
</body>
</html>